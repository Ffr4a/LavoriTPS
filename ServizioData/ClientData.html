<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Servizio Giorno della Settimana</title>
    <style>
        /* Stile per la visualizzazione dei messaggi */
        #messages {
            border: 1px solid #ccc;
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            max-height: 200px;
            overflow-y: auto;
        }
        .info {
            color: blue;
        }
        .error {
            color: red;
        }
    </style>
    <script>
        let requestInProgress = false; // Flag per tenere traccia dello stato della richiesta

        function logMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = type;
            messageElement.textContent = message;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight; // Scorri in basso per mostrare l'ultimo messaggio
        }

        async function fetchDayOfWeek() {
            if (requestInProgress) {
                const errorMessage = "Richiesta già in corso, non ne può essere avviata una nuova.";
                logMessage(errorMessage, 'error');
                document.getElementById('result').innerText = errorMessage;
                return; // Se una richiesta è già in corso, non farne un'altra
            }

            const button = document.querySelector('button'); // Seleziona il bottone
            button.disabled = true; // Disabilita il bottone dopo il clic
            requestInProgress = true; // Imposta il flag quando inizia la richiesta
            
            // Ottieni i valori del giorno, mese e anno
            const day = document.getElementById('day').value;
            const month = document.getElementById('month').value;
            const year = document.getElementById('year').value;

            if (!day || !month || !year) {
                const errorMessage = "Per favore compila tutti i campi.";
                logMessage(errorMessage, 'error');
                document.getElementById('result').innerText = errorMessage;
                button.disabled = false;
                requestInProgress = false;
                return;
            }

            logMessage(`Richiesta di invio: Giorno = ${day}, Mese = ${month}, Anno = ${year}`);

            const xmlMessage = `
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:urn="urn:getDayOfWeek">
    <soapenv:Header/>
    <soapenv:Body>
        <urn:getDayOfWeek>
            <day>${day}</day>
            <month>${month}</month>
            <year>${year}</year>
        </urn:getDayOfWeek>
    </soapenv:Body>
</soapenv:Envelope>
`;

            logMessage("Richiesta inviata al server...");

            const request = new XMLHttpRequest();
            request.open('POST', 'http://localhost:8081/DateService', true);
            request.setRequestHeader('Content-Type', 'text/xml; charset=UTF-8');
            request.send(xmlMessage);

            request.onload = function() {
                logMessage("Richiesta completata.");
                if (request.status === 200) {
                    logMessage("Risposta ricevuta dal server.");
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(request.response, 'text/xml');

                    document.getElementById('xmlResponse').innerText = request.response; // Visualizza la risposta XML

                    const errorElement = xmlDoc.getElementsByTagName('urn:error')[0];
                    if (errorElement) {
                        const detailedErrorMessage = "Errore trovato nel messaggio: " + errorElement.textContent;
                        logMessage(detailedErrorMessage, 'error');
                        document.getElementById('result').innerText = detailedErrorMessage;
                    } else {
                        const result = xmlDoc.getElementsByTagName('urn:return')[0]?.textContent;
                        if (result) {
                            logMessage("Risultato trovato: " + result);
                            document.getElementById('result').innerText = result; 
                        } else {
                            const noResultMessage = "Nessun risultato trovato.";
                            logMessage(noResultMessage, 'error');
                            document.getElementById('result').innerText = noResultMessage;
                        }
                    }
                } else {
                    const errorResponseMessage = 'Errore nella richiesta: ' + request.statusText;
                    logMessage(errorResponseMessage, 'error');
                    document.getElementById('result').innerText = errorResponseMessage;
                }
                button.disabled = false; // Riabilita il bottone
                requestInProgress = false; // Reset del flag dopo la richiesta
            };

            request.onerror = function() {
                const connectionErrorMessage = `Errore nella connessione: ${request.statusText}. 
                Controlla il seguente URL: http://localhost:8081/DateService.
                Status Code: ${request.status}. 
                Potrebbe essere necessario verificare se il server è in esecuzione e se l'indirizzo è corretto.`;
                logMessage(connectionErrorMessage, 'error');
                document.getElementById('result').innerText = connectionErrorMessage;
                button.disabled = false; // Riabilita il bottone
                requestInProgress = false; // Reset del flag dopo errore
            };

            logMessage("Richiesta inviata: " + xmlMessage);
        }
    </script>
</head>
<body>
    <h1>Servizio Giorno della Settimana</h1>
    <label for="day">Giorno:</label>
    <input type="number" id="day" min="1" max="31" required>

    <label for="month">Mese:</label>
    <input type="number" id="month" min="1" max="12" required>

    <label for="year">Anno:</label>
    <input type="number" id="year" required>

    <button onclick="fetchDayOfWeek()">Invia</button>

    <h2>Risultato:</h2>
    <div id="result"></div>
    <h2>Risposta XML:</h2>
    <pre id="xmlResponse"></pre>

    <h2>Messaggi di Stato:</h2>
    <div id="messages"></div>
</body>
</html>
